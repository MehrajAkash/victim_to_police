<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Police â€” Listen for Alerts</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <main class="card">
        <h1>Incoming Alerts</h1>
        <ul id="alertsList" class="alerts"></ul>
    </main>


    <script type="module">
        // TODO: paste same Firebase config object here
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };


        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";


        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);


        const alertsList = document.getElementById('alertsList');


        function formatTime(ts) {
            const d = new Date(ts);
            return d.toLocaleString();
        }

        const alertsRef = ref(db, 'alerts');
        onChildAdded(alertsRef, (snap) => {
            const data = snap.val();
            const li = document.createElement('li');
            li.className = 'alert';


            const when = formatTime(data.ts || Date.now());
            const msg = document.createElement('div');
            msg.innerHTML = `<strong>${when}</strong><br>${escapeHtml(data.message || '(no message)')}`;


            const loc = document.createElement('div');
            if (data.lat && data.lon) {
                // Link to open Google Maps in a new tab
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${data.lat},${data.lon}`;
                loc.innerHTML = `Location: ${data.lat.toFixed(6)}, ${data.lon.toFixed(6)} â€” <a href="${mapsUrl}" target="_blank">Open in Maps</a>`;
            } else {
                loc.textContent = 'Location: not provided';
            }


            li.appendChild(msg);
            li.appendChild(loc);
            alertsList.insertBefore(li, alertsList.firstChild);


            // Optionally flash or play sound
            flashWindow();
        });


        function escapeHtml(text) {
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function flashWindow() {
            // Simple visual flash
            document.body.animate([{ background: '#fff' }, { background: '#fffbdb' }, { background: '#fff' }], { duration: 800 });
            // Try to get attention via title
            const oldTitle = document.title;
            let step = 0;
            const t = setInterval(() => {
                document.title = step % 2 === 0 ? 'ðŸ”” New Alert!' : oldTitle;
                step++;
                if (step > 5) {
                    clearInterval(t);
                    document.title = oldTitle;
                }
            }, 700);
        }
    </script>
</body>

</html>